EN

HTTP Request Blocker via Log (PHP + Cron)

This PHP script automatically blocks IP addresses that generate an excessive volume of HTTP requests within a short period of time. The goal is to mitigate simple flood attacks, bots, aggressive crawlers, and basic denial-of-service (DDoS) attempts.

The blocking is applied directly to the .htaccess file, based on the analysis of the Apache access log managed by Virtualmin.

------------

How It Works

The script performs the following steps:

Reads the domain’s HTTP access log file.

Analyzes requests made within a configurable time window.

Counts the number of requests per IP address.

If an IP exceeds the defined request limit, it is blocked.

The block is automatically applied to the .htaccess file.

Old blocks generated by the script are removed before new ones are added.

All blocks are managed below the comment # Auto bloqueio, preserving any existing rules above this marker.

------------

Configuration

The main script settings are defined at the beginning of the file:

$user = 'trevomoveis'; // system user
$website = 'trevomoveis.com.br'; // domain
$log = "/var/log/virtualmin/".$website."_access_log"; // log path
$limit = 1200; // maximum number of requests
$window = 600; // time window in seconds (10 minutes)

Rule Example

An IP address that makes more than 1200 requests within 10 minutes will be automatically blocked.

------------

Files Used

Analyzed access log:
/var/log/virtualmin/DOMAIN_access_log

File modified for blocking:
/home/USER/public_html/.htaccess

Example of content generated in the .htaccess file:

#Auto bloqueio

Deny from 192.168.1.100
Deny from 203.0.113.45

------------

Cron Configuration

For the blocking to work automatically, the script must be executed periodically via cron.

Execution permission (optional)
chmod +x /home/trevomoveis/public_html/blocker_http.php

------------

Cron Editing

Edit the cron of the user responsible for the website:

crontab -e

Add the following line:

*/5 * * * * /usr/bin/php /home/trevomoveis/public_html/blocker_http.php >/dev/null 2>&1

This will cause the script to run every 5 minutes without generating output or cron emails.

------------

Manual Execution

To test the script manually, run:

php /home/trevomoveis/public_html/blocker_http.php

Blocked IP addresses will be displayed in the standard output.


------------------------------------------------------


PT-BR

HTTP Request Blocker via Log (PHP + Cron)

Este script PHP realiza o bloqueio automático de endereços IP que fazem um volume excessivo de requisições HTTP em um curto período de tempo. O objetivo é mitigar ataques simples de flood, bots, crawlers agressivos e tentativas básicas de negação de serviço (DDoS).

O bloqueio é feito diretamente no arquivo .htaccess, com base na análise do arquivo de log de acesso do Apache gerenciado pelo Virtualmin.

------------

Funcionamento

O script executa as seguintes etapas:

Lê o arquivo de log de acesso HTTP do domínio.

Analisa as requisições realizadas dentro de uma janela de tempo configurável.

Conta o número de acessos por endereço IP.

Caso um IP ultrapasse o limite definido de requisições, ele é bloqueado.

O bloqueio é aplicado automaticamente no arquivo .htaccess.

Bloqueios antigos gerados pelo script são removidos antes da inserção dos novos.

Todos os bloqueios são gerenciados abaixo do comentário # Auto bloqueio, preservando qualquer regra existente acima desse marcador.

------------

Configurações

As principais configurações do script estão no início do arquivo:

$user = 'trevomoveis'; // usuário do sistema
$website = 'trevomoveis.com.br'; // domínio
$log = "/var/log/virtualmin/".$website."_access_log"; // caminho do log
$limit = 1200; // número máximo de requisições
$window = 600; // janela de tempo em segundos (10 minutos)

Exemplo de regra

Um endereço IP que realizar mais de 1200 requisições dentro de 10 minutos será automaticamente bloqueado.

------------

Arquivos Utilizados

Log de acesso analisado:
/var/log/virtualmin/DOMINIO_access_log

Arquivo modificado para bloqueio:
/home/USUARIO/public_html/.htaccess

Exemplo de conteúdo gerado no .htaccess:

#Auto bloqueio
Deny from 192.168.1.100
Deny from 203.0.113.45

------------

Configuração do Cron

Para que o bloqueio funcione de forma automática, o script deve ser executado periodicamente via cron.

Permissão de execução (opcional)
chmod +x /home/trevomoveis/public_html/blocker_http.php

------------

Edição do cron

Edite o cron do usuário responsável pelo site:

crontab -e

Adicione a seguinte linha:

*/5 * * * * /usr/bin/php /home/trevomoveis/public_html/blocker_http.php >/dev/null 2>&1


Isso fará com que o script seja executado a cada 5 minutos, sem gerar saída ou e-mails do cron.

------------

Execução Manual

Para testar o funcionamento manualmente, execute:

php /home/trevomoveis/public_html/blocker_http.php


Os IPs bloqueados serão exibidos na saída padrão.
